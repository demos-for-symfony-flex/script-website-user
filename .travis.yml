---
language: php

addons:
  apt:
    packages:
    - elinks # For dysplaying php files on console.

cache:
  directories:
  - $HOME/.composer/cache/files

php:
- nightly
- 7.2
- 7.1
- 7.0

env:
  global:
  - PATH=$TRAVIS_BUILD_DIR/website-skeleton/bin:$TRAVIS_BUILD_DIR/website-skeleton/vendor/bin:$HOME/vendor/bin:$PATH

matrix:
  fast_finish: true
  allow_failures:
  - php: nightly

before_install:
- go get -u github.com/jingweno/ccat
# Disabling Xdebug - Debugger and Profiler Tool for PHP
- php -r "print_r(get_loaded_extensions(TRUE));";
  if [ -f ~/.phpenv/versions/$(phpenv version-name)/etc/conf.d/xdebug.ini ]; then
    cat ~/.phpenv/versions/$(phpenv version-name)/etc/conf.d/xdebug.ini;
    install --directory ~/.phpenv/versions/$(phpenv version-name)/etc/on-demand;
    mv ~/.phpenv/versions/$(phpenv version-name)/etc/conf.d/xdebug.ini ~/.phpenv/versions/$(phpenv version-name)/etc/on-demand;
    php -r "print_r(get_loaded_extensions(TRUE));";
  fi

install:
- composer create-project --no-install symfony/website-skeleton
- cd website-skeleton
- cp ../.env.dist .
- composer install
- install --directory config/packages
# - composer require symfony/yaml # in symfony/website-skeleton
# - composer require symfony/console # in symfony/website-skeleton
# - composer require symfony/twig-bundle # in symfony/website-skeleton
# - composer require sensio/framework-extra-bundle # in symfony/website-skeleton
# - composer require symfony/orm-pack # in symfony/website-skeleton
# - composer require symfony/swiftmailer-bundle # in symfony/website-skeleton
# - composer require symfony/security-csrf
- cp ../config/packages/*.yaml config/packages
- cp ../config/routes/*.yaml config/routes
- composer require friendsofsymfony/user-bundle
- console doctrine:database:create
# - console doctrine:migrations:diff --quiet
# - console doctrine:migrations:migrate --no-interaction --quiet
- console doctrine:schema:update --force
- console assets:install --symlink

- composer global require sensiolabs/security-checker # --no-scripts

script: true

after_script:
- composer show --latest
- ls -A ~
- composer global security:check -- --end-point=http://security.sensiolabs.org/check_lock --ansi
- ls --almost-all --color
- cat .env
- cat .env.dist
- ls --color bin
- ls --almost-all --recursive --color var
- ls --color src
- ls --color src/Controller
- ls --color src/Entity
- php -s src/Entity/User.php | elinks -force-html -dump-color-mode 4 -dump
- ls --color src/Repository
- php -s src/Repository/AuthorRepository.php | elinks -force-html -dump-color-mode 4 -dump
- php -s src/Repository/BlogPostRepository.php | elinks -force-html -dump-color-mode 4 -dump
- composer console -- doctrine:query:sql "INSERT INTO author (name) VALUES ('Tom B. Erichsen')"
- composer console -- doctrine:query:dql "SELECT a FROM App\Entity\Author a"
- composer console -- doctrine:query:sql "SELECT * FROM author"

- ls --recursive --color config
- php -s           config/bundles.php | elinks -force-html -dump-color-mode 4 -dump
- $GOPATH/bin/ccat config/routes.yaml
- $GOPATH/bin/ccat config/services_test.yaml
- $GOPATH/bin/ccat config/services.yaml
- $GOPATH/bin/ccat config/packages/doctrine.yaml
- $GOPATH/bin/ccat config/packages/easy_admin.yaml
- $GOPATH/bin/ccat config/packages/fos_user.yaml
- $GOPATH/bin/ccat config/packages/framework.yaml
- $GOPATH/bin/ccat config/packages/translation.yaml
- $GOPATH/bin/ccat config/packages/routing.yaml
- $GOPATH/bin/ccat config/packages/security.yaml
- $GOPATH/bin/ccat config/routes/annotations.yaml
- $GOPATH/bin/ccat config/routes/dev/twig.yaml
- $GOPATH/bin/ccat config/routes/dev/web_profiler.yaml

- console debug:router
- console server:start &
- printf 'HEAD /admin/dashboard HTTP/1.1\r\n\r\n' | socat - TCP4:localhost:8000,forever >/dev/null # Waiting for server to connect.
- elinks http://localhost:8000/login -dump-color-mode 4 -dump
# - elinks http://localhost:8000/index.php/admin -dump-color-mode 4 -dump


- composer show --latest
- $GOPATH/bin/ccat composer.json

- console --ansi

- console list debug --ansi
- console help debug:router --ansi

- console list doctrine --ansi
- console help doctrine:database:create --ansi
# - console help doctrine:generate:entities --ansi
- console help doctrine:mapping:convert --ansi
- console help doctrine:mapping:import --ansi
- console help doctrine:mapping:info --ansi
- console help doctrine:migrations:diff --ansi
- console help doctrine:migrations:migrate --ansi
- console help doctrine:query:dql --ansi
- console help doctrine:query:sql --ansi
- console help doctrine:schema:update --ansi
- console help doctrine:schema:validate --ansi

- console list make --ansi
- console help make:crud --ansi
- console help make:entity --ansi
- console help make:migration --ansi
- console help make:unit-test --ansi

- console list router --ansi
- console help router:match --ansi

- console list server --ansi
- console help server:start --ansi
